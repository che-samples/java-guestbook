schemaVersion: 2.1.0
metadata:
  name: java-guestbook
# attributes:
#   che-theia.eclipse.org/sidecar-policy: USE_DEV_CONTAINER
components:
  - name: maven
    container:
      # image: quay.io/devfile/universal-developer-image:ubi8-112f94a
      # image: quay.io/vgulyy/universal-developer-image:ubi8-REV0
      image: quay.io/eclipse/che-java11-maven:next
      memoryLimit: 512Mi
      # memoryLimit: 3Gi

      endpoints:
        - name: java-guestbook-backend
          exposure: public
          protocol: http
          targetPort: 8080

        - name: java-guestbook
          exposure: public
          protocol: tcp
          targetPort: 8443

        - name: debug
          exposure: none
          protocol: tcp
          targetPort: 5005
      
      env:
        - name: MAVEN_CONFIG
          value: ""

        - name: JAVA_OPTS
          value: "-XX:MaxRAMPercentage=50.0 -XX:+UseParallelGC -XX:MinHeapFreeRatio=10
                -XX:MaxHeapFreeRatio=20 -XX:GCTimeRatio=4 -XX:AdaptiveSizePolicyWeight=90
                -Dsun.zip.disableMemoryMapping=true -Xms20m -Djava.security.egd=file:/dev/./urandom
                -Duser.home=/home/user"

        - name: MAVEN_OPTS
          value: $(JAVA_OPTS)

      volumeMounts:
        - name: m2
          path: /home/user/.m2

  - name: mongo
    container:
      image: quay.io/eclipse/che--centos--mongodb-36-centos7:latest-ffdf2431bbc6d9a9d2a03e95bbbe8adb49ab9eac301f268a35038c84288259c1
      memoryLimit: 300Mi
      env:
      - name: MONGODB_USER
        value: user

      - name: MONGODB_PASSWORD
        value: password

      - name: MONGODB_DATABASE
        value: guestbook
        
      - name: MONGODB_ADMIN_PASSWORD
        value: password

      endpoints:
        - name: java-guestbook-mongodb
          # exposure: none
          exposure: public
          protocol: tcp
          targetPort: 27017
      
      volumeMounts:
        - name: mongodbdata
          path: /var/lib/mongodb/data

  - name: m2
    volume:
      size: 1G

  - name: mongodbdata
    volume:
      size: 1G

commands:
  - id: maven-build-backend
    exec:
      label: "build backend"
      component: maven
      workingDir: "${PROJECTS_ROOT}/java-guestbook/backend"
      commandLine: "mvn clean install"
      group:
        kind: build
        isDefault: true

  - id: maven-test-backend
    exec:
      label: "test backend"
      component: maven
      workingDir: "${PROJECTS_ROOT}/java-guestbook/backend"
      commandLine: "./test.sh"
      group:
        kind: test
        isDefault: true

  - id: maven-build-frontend
    exec:
      label: "build frontend"
      component: maven
      workingDir: "${PROJECTS_ROOT}/java-guestbook/frontend"
      commandLine: "mvn clean install"
      group:
        kind: build
        isDefault: true

  - id: run-backend
    exec:
      label: "run backend"
      component: maven
      workingDir: "${PROJECTS_ROOT}/java-guestbook/backend"
      commandLine: |
        java -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5006,quiet=y \
        -jar target/backend-1.0.jar
      group:
        kind: run
        isDefault: true

  - id: run-frontend
    exec:
      label: "run frontend"
      component: maven
      workingDir: "${PROJECTS_ROOT}/java-guestbook/frontend"
      commandLine: |
        java -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5005,quiet=y \
        -jar target/frontend-1.0.jar
      group:
        kind: run
        isDefault: true
