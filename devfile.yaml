schemaVersion: 2.1.0
metadata:
  name: java-guestbook
# attributes:
#   che-theia.eclipse.org/sidecar-policy: USE_DEV_CONTAINER
components:
  - name: maven
    container:
      image: quay.io/devfile/universal-developer-image:ubi8-b452131
      memoryLimit: 512Mi
      # memoryLimit: 3Gi

      endpoints:
        - name: java-guestbook-backend
          exposure: public
          protocol: http
          targetPort: 8080

        - name: java-guestbook
          exposure: public
          protocol: tcp
          targetPort: 8443

        - name: debug
          exposure: none
          protocol: tcp
          targetPort: 5005
      
      env:
        - name: MAVEN_CONFIG
          value: ""

        - name: JAVA_OPTS
          value: "-XX:MaxRAMPercentage=50.0 -XX:+UseParallelGC -XX:MinHeapFreeRatio=10
                -XX:MaxHeapFreeRatio=20 -XX:GCTimeRatio=4 -XX:AdaptiveSizePolicyWeight=90
                -Dsun.zip.disableMemoryMapping=true -Xms20m -Djava.security.egd=file:/dev/./urandom
                -Duser.home=/home/user"

        - name: MAVEN_OPTS
          value: $(JAVA_OPTS)

      volumeMounts:
        - name: m2
          path: /home/user/.m2


  # - name: tools
  #   container:
  #     image: quay.io/eclipse/che-java11-maven:next
  #     endpoints:
  #       - exposure: none
  #         name: debug
  #         protocol: tcp
  #         targetPort: 5005
  #       - exposure: public
  #         name: 8080-tcp
  #         protocol: http
  #         targetPort: 8080
  #     volumeMounts:
  #       - name: m2
  #         path: /home/user/.m2
  #     memoryLimit: 3Gi

  - name: m2
    volume:
      size: 1G

commands:
  - id: list-projects-directory
    exec:
      component: m2
      workingDir: ${PROJECTS_ROOT}/java-guestbook
      commandLine: ls -la
      group:
        kind: run
        isDefault: true

  - id: maven-build-backend
    exec:
      component: maven
      workingDir: "${PROJECTS_ROOT}/java-guestbook/backend"
      commandLine: >-
        mvn clean install
      group:
        kind: run
        isDefault: true

  - id: maven-build-frontend
    exec:
      component: maven
      workingDir: "${PROJECTS_ROOT}/java-guestbook/frontend"
      commandLine: >-
        mvn clean install
      group:
        kind: run
        isDefault: true

  # - id: run
  #   exec:
  #     component: tools
  #     workingDir: ${PROJECTS_ROOT}/java-spring-petclinic
  #     commandLine: >-
  #       java -jar target/*.jar
  #     group:
  #       kind: run
  #       isDefault: true

  # - id: run-debug
  #   exec:
  #     component: tools
  #     workingDir: ${PROJECTS_ROOT}/java-spring-petclinic
  #     commandLine: >-
  #       java -jar -Xdebug -Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=5005 target/*.jar
  #     group:
  #       kind: run
  #       isDefault: true
